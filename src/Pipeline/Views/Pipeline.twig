<script>
  function onFilterChange() {
    const fDealResult = document.getElementById("fDealResult").value;
    const fIdPipeline = document.getElementById("fIdPipeline").value;
    const fOwner = globalThis.main.reactElements['fOwner'].state.value;

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const idPipeline = fIdPipeline ?? urlParams.get('id_pipeline');

    let url = '?';
    if (idPipeline) url += 'id_pipeline=' + idPipeline;
    if (fDealResult) url += '&fDealResult=' + fDealResult;
    if (fOwner) url += '&fOwner=' + fOwner;

    window.location.href = url;
  }
</script>

{% set resultEnumValues = {
  1: {"color":"#a8aba7","title":"Pending"},
  2: {"color":"#14ab0c","title":"Won"},
  3: {"color":"#c42202","title":"Lost"},
} %}

<div class="flex gap-2 flex-col md:flex-row" style="height:calc(100vh - var(--nav-height) - 1rem)">
  <div class="flex flex-col flex-grow overflow-auto">
    <h1 class="app-main-title">{{ viewParams.pipelineTypeReadable }}</h1>

    <div class="flex flex-row gap-4 mb-2 justify-between">
      <div class="flex flex-row gap-2">
      </div>
    </div>

    <div class="card card-horizontal mb-2">
      <div class="card-header">
        <i class="fas fa-magnifying-glass"></i>
      </div>
      <div class="card-body flex gap-2">
        <div class="input-wrapper flex-1">
          <div class="input-label">Pipeline</div>
          <div class="input-body">
            <select
              class="w-full"
              name="fIdPipeline"
              id="fIdPipeline"
              onchange="onFilterChange()"
            >
              {% for pipeline in viewParams.pipelines %}
                <option value="{{ pipeline.id }}"
                {% if pipeline.id == viewParams.pipeline.id %} selected {% endif %}
                >{{ pipeline.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="input-wrapper flex-1">
          <div class="input-label">Owner</div>
          <div class="input-body">
            <app-input-lookup
              uid="fOwner"
              model="HubletoApp/Community/Settings/Models/User"
              class="w-full"
              value="{{ viewParams.fOwner }}"
              function:on-change="onFilterChange();"
            />
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col items-stretch md:flex-row justify-start gap-2 overflow-auto">
      {% for step in viewParams.pipeline.STEPS %}

        {% set itemsInStep = 0 %}
        {% for item in viewParams.items %}
          {% if item.id_pipeline_step == step.id %} {% set itemsInStep = itemsInStep + 1 %} {% endif %}
        {% endfor %}

        {# Step Containter #}
        <div class="card {{ itemsInStep == 0 ? "flex-2 shrink" : "flex-3" }}">

          <div class="card-header flex flex-col gap-1" style="border-top: 0.5em solid {{ step.color }}">
            <span class="text-base text-nowrap">{{ step.name }}</span>
          </div>

          <div class="card-body overflow-auto flex flex-row flex-wrap md:block">
            {% for item in viewParams.items %}
              {% if item.id_pipeline_step == step.id %}
                <div class="card mb-2 w-full md:w-auto hover:border-primary"><a class="hover:no-underline" href="{{ viewParams.itemDetailsUrl }}/{{item.id}}" target="_blank">
                  <div class="card-header rounded flex flex-col p-2 text-sm font-normal">
                    <div class="flex justify-between w-full">
                      <div class="flex flex-col truncate">
                        <div>{{item.identifier}}</div>
                        <div class="text-gray-400">{{item.CUSTOMER.name}}</div>
                        <div class="font-bold">{{item.title}}</div>
                      </div>
                      <div class="mt-1">
                        <div class="mb-3 pr-2 text-right font-normal" style="border-right: 0.5em solid {{ resultEnumValues[item.deal_result]["color"] }}">{{ resultEnumValues[item.deal_result]["title"] }}</div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body text-sm">
                    <div>Owner: {{ item.OWNER.email }}</div>
                    {% if item.note %} <div class="bg-yellow-50 p-2 text-yellow-800 whitespace-pre">{{ item.note }}</div> {% endif %}
                  </div>
                </a></div>
              {% endif %}
            {% endfor %}
          </div>
{# 
          <div class="card-footer">
            <a
              class="btn btn-transparent"
              href="deals/add?id_pipeline={{ viewParams.pipeline.id }}&id_pipeline_step={{ step.id }}"
              target="_blank"
            >
              <span class="icon"><i class="fas fa-add"></i></span>
              <span class="text text-nowrap">{{ translate('Add item') }}</span>
            </a>
          </div> #}
        </div>
      {% endfor %}
    </div>
  </div>
</div>